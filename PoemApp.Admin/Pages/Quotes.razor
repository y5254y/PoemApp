@page "/quotes"
@attribute [Authorize(Roles = "Admin")]
@using PoemApp.Core.DTOs
@using PoemApp.Client.ApiClients
@using MudBlazor
@inject QuotesApiClient QuotesClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">名言名句管理</MudText>
    <MudDivider Class="my-2" />

    <MudTable T="QuoteDto" Items="_items" Striped="true" Hover="true" Bordered="true">
        <ToolBarContent>
            <MudTextField @bind-Value="_search" Placeholder="搜索内容/作者/诗文" Adornment="Adornment.Start" AdornmentIcon="Icons.Material.Filled.Search" Immediate="true" />
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Create">新建名句</MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>内容</MudTh>
            <MudTh>作者</MudTh>
            <MudTh>来源/诗文</MudTh>
            <MudTh>创建时间</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Content</MudTd>
            <MudTd>@context.AuthorName</MudTd>
            <MudTd>@(string.IsNullOrWhiteSpace(context.Source) ? context.PoemTitle : context.Source)</MudTd>
            <MudTd>@context.CreatedAt.ToString("yyyy-MM-dd")</MudTd>
            <MudTd>
                <MudButton Variant="Variant.Text" OnClick="() => Edit(context.Id)">编辑</MudButton>
                <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="() => ConfirmDelete(context.Id)">删除</MudButton>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<QuoteDto> _items = new();
    private string _search = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        try
        {
            _items = await QuotesClient.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add("加载失败: " + ex.Message, Severity.Error);
        }
    }

    private void Create() => Navigation.NavigateTo("/quotes/edit/0");
    private void Edit(int id) => Navigation.NavigateTo($"/quotes/edit/{id}");

    private async Task ConfirmDelete(int id)
    {
        var ok = await DialogService.ShowMessageBox("删除确认", "确认删除该名句？", yesText: "删除", noText: "取消");
        if (ok == true)
        {
            var success = await QuotesClient.DeleteAsync(id);
            if (success) { Snackbar.Add("删除成功", Severity.Success); await Load(); }
            else Snackbar.Add("删除失败", Severity.Error);
        }
    }
}
