@page "/users"
@attribute [Authorize(Roles = "Admin")]
@using PoemApp.Admin.Services
@using PoemApp.Core.DTOs
@using PoemApp.Core.Enums
@using PoemApp.Core.Extensions
@using PoemApp.Client.ApiClients
@inject UsersApiClient UsersClient
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">用户管理</MudText>
    <MudDivider Class="my-2" />

    <MudTable T="BasicUserDto" ServerData="@((TableState s, CancellationToken ct) => ServerReload(s, ct))" @ref="_table" Striped="true" Hover="true" RowsPerPageOptions="new int[]{5,10,20}" Bordered="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">用户管理</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreate">新增用户</MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>用户名</MudTh>
            <MudTh>角色</MudTh>
            <MudTh>积分</MudTh>
            <MudTh>操作</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="用户名">@context.Username</MudTd>
            <MudTd DataLabel="角色">@context.RoleDisplayName</MudTd>
            <MudTd DataLabel="积分">@context.Points</MudTd>
            <MudTd DataLabel="操作">
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => NavigateToUserDetail(context.Id)">查看详情</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private MudTable<BasicUserDto>? _table;

    private string _search = string.Empty;
    private UserRole? _filterRole = null;
    private bool? _filterVipBool = null; // null=all, true=yes, false=no

    private async Task<TableData<BasicUserDto>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        try
        {
            var page = state.Page + 1; // MudTable uses zero-based page index
            var pageSize = state.PageSize;
            var res = await UsersClient.GetAllAsync(page, pageSize, _search, _filterRole, _filterVipBool);
            return new TableData<BasicUserDto>() { TotalItems = res.TotalCount, Items = res.Items };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
            return new TableData<BasicUserDto>() { TotalItems = 0, Items = new List<BasicUserDto>() };
        }
    }

    private async Task ReloadTable()
    {
        if (_table != null) await _table.ReloadServerData();
    }

    private void OpenCreate()
    {
        Navigation.NavigateTo("/users/edit/0");
    }

    private void Edit(int id)
    {
        Navigation.NavigateTo($"/users/edit/{id}");
    }

    private async Task ConfirmDelete(int id)
    {
        var confirmed = await DialogService.ShowMessageBox("删除确认", $"确认删除用户 {id} 吗", yesText: "确认", noText: "取消");
        if (confirmed == true)
        {
            await DoDelete(id);
            if (_table != null) await _table.ReloadServerData();
        }
    }

    private async Task DoDelete(int id)
    {
        try
        {
            var ok = await UsersClient.DeleteAsync(id);
            if (ok)
            {
                Snackbar.Add("删除成功", Severity.Success);
            }
            else
            {
                Snackbar.Add("删除失败", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("删除失败: " + ex.Message, Severity.Error);
        }
    }

    private void NavigateToUserDetail(int userId)
    {
        Navigation.NavigateTo($"/users/{userId}");
    }
}
