@using PoemApp.Core.DTOs
@using MudBlazor
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">重置密码</MudText>
        <EditForm Model="_model" OnValidSubmit="Submit">
            <DataAnnotationsValidator />
            <MudTextField @bind-Value="_model.NewPassword" Label="新密码" InputType="InputType.Password" Required="true" />
            <MudTextField @bind-Value="_confirm" Label="确认密码" InputType="InputType.Password" Required="true" />
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">取消</MudButton>
        <MudButton OnClick="Submit" Variant="Variant.Filled">提交</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] object? MudDialog { get; set; }
    [Parameter] public int UserId { get; set; }

    private ChangePasswordDto _model = new();
    private string _confirm = string.Empty;

    private void Cancel()
    {
        try
        {
            if (MudDialog != null) ((dynamic)MudDialog).Cancel();
        }
        catch
        {
            // ignore
        }
    }

    private void Submit()
    {
        if (string.IsNullOrEmpty(_model.NewPassword) || _model.NewPassword.Length < 6)
        {
            Snackbar.Add("密码长度至少为6位", Severity.Warning);
            return;
        }
        if (_model.NewPassword != _confirm)
        {
            Snackbar.Add("密码与确认密码不一致", Severity.Warning);
            return;
        }

        try
        {
            if (MudDialog != null) ((dynamic)MudDialog).Close(DialogResult.Ok(_model.NewPassword));
        }
        catch
        {
            // fallback: try DialogService close not available here
        }
    }
}